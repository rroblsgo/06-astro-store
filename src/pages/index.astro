---
import MainLayout from '@/layouts/MainLayout.astro';
import { getSession } from 'auth-astro/server';
import { actions } from 'astro:actions';
import { ProductList } from '@/components';
import Pagination from '@/components/shared/Pagination.astro';

const session = await getSession(Astro.request);
console.log('User session (index.astro):', session);
const { user } = session ?? {};

const searchParams = Astro.url.searchParams;
const pageParam = Number(searchParams.get('page') ?? 1);

const { data, error } = await Astro.callAction(actions.getProductsByPage, {
  page: pageParam,
  limit: 12,
});

if (error) return Astro.redirect('/');
const { products, totalPages } = data;

if (data.products.length === 0) {
  console.log('No products found (index.astro)');
  return Astro.redirect(`/?page=${totalPages}`);
}
// console.log('Products (index.astro):', products);
---

<MainLayout>
  <h1 class="text-3xl">Listado de productos</h1>
  <ProductList products={products} client:idle />
  <Pagination totalPages={totalPages} />
  <!-- {user ? (
    <div class="mt-4 p-4">
    <code>
      <p>{'{'}</p>
      <p>id: {user?.id}</p>
      <p>email: {user?.email}</p>
      <p>name: {user?.name}</p>
      <p>role: {user?.role}</p>
      <p>createdAt: {user?.createdAt}</p>
      <p>{'}'}</p>
    </code>
  </div>
  ) : (
    <p class="mt-2">You are not logged in. Please log in to access more features.</p>
  )} -->
</MainLayout>
